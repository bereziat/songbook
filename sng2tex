#! /usr/bin/perl -lw
# (c) 2015 D.Bereziat

use strict;

# EntÃªte LaTeX
my ($title,$authors,$cr,%chords);
print "\\documentclass{article}";
print "\\usepackage{fullpage}";
print "\\usepackage[chorded]{songs}";
print "\\usepackage[utf8]{inputenc}";
print "\\noversenumbers";
print "\\begin{document}";
print "\\begin{songs}{}";

for my $file (@ARGV) {
  open (F, "<$file") ;

  do { $_=<F>} while (/^%%/) ;
  $title = $_;
  chomp $title;
  do { $_=<F>} while (/^%%/) ;
  $authors = $_;
  chomp $authors;

  print "\\beginsong{$title}[by={$authors}]";

  # read chords definition
  while ( <F>) {
    # Skips comments
    next if /^%%/;
    # Chord definitions
    do { print "\\gtab{$1}{$2}"; next} if /^%chord +(\S+) +(\S+)/;
    last;
  }

  print "\\beginverse";

  while( <F>) {
    # Comments
    next if /^%%/;

    # Annotations
    do { print "\\textnote{$1}"; next} if /^%\s+(.*)/ ;

    # Chords
    s/\[/\\[/g;

    # Bemol in chords (convert b to &)
    while (s/(\[[^\]])b(?=.*\])/$1\&/) {};

    # capture words group / isolated letter(s) with _ marker
    while (s/\](([^_\[]+)_)/\]\{$2\}/) {};

    print ;
  }
  close F;

  print "\\endverse";
  print "\\endsong";
}

print "\\end{songs}";
print "\\end{document}"

